<p style="color: green"><%= notice %></p>

<h1>FOFA Count</h1>
<p>说明： 该页面是为了后续的 从fofa上抓取数据做准备。对于数量特别大的，需要做手动甄别 </p>
<%= form_tag '', method: 'GET' do |f| %>
  Project: <%= select_tag :project_id, options_from_collection_for_select(Project.all, :id, :name, params[:project_id]), include_blank: 'All', class: 'form_select' %>
    per page: <%= select_tag :per_page, options_for_select([1000, 500, 100], params[:per_page].to_i), class: 'form_select' %>
    Sort by: <%= select_tag :sort_by, options_for_select([
      ['Subdomain Total Count', 'subdomain_total_count_of_fofa_result'],
      ['Subdomain Count (Main Domain)', 'subdomain_count_main_domain_of_fofa_result'],
      ['Subdomain Count (Base Name)', 'subdomain_count_base_name_of_fofa_result'],
      ['Subdomain Count (Favicon)', 'subdomain_count_favicon_of_fofa_result']
    ], params[:sort_by]), include_blank: 'Default', class: 'form_select' %>
    Order: <%= select_tag :sort_order, options_for_select([['Ascending', 'asc'], ['Descending', 'desc']], params[:sort_order]), class: 'form_select' %>
    Favicon Hash of FOFA: <%= select_tag :favicon_hash_of_fofa_filter, options_for_select([['All', ''], ['Null', 'null'], ['Not Null', 'not_null']], params[:favicon_hash_of_fofa_filter]), include_blank: 'Default', class: 'form_select' %>
    
  <%= submit_tag 'Search', class: 'btn btn-primary' %>
<% end %>

<br/>
<%= paginate @servers %>

<!-- Modal for editing favicon URL -->
<div class="modal fade" id="editFaviconUrlModal" tabindex="-1" role="dialog" aria-labelledby="editFaviconUrlModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editFaviconUrlModalLabel">编辑 Favicon URL</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editFaviconUrlForm">
          <input type="hidden" id="editServerId" value="">
          <div class="form-group">
            <label for="faviconUrlInput" class="col-form-label">Favicon URL:</label>
            <input type="text" class="form-control" id="faviconUrlInput">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveFaviconUrlBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Function to open the modal for editing favicon URL
  function openEditFaviconUrlModal(serverId, currentUrl) {
    // Set the server ID and current favicon URL in the modal
    document.getElementById('editServerId').value = serverId;
    document.getElementById('faviconUrlInput').value = currentUrl;
    
    // Show the modal
    $('#editFaviconUrlModal').modal('show');
  }
  
  // Function to save the favicon URL
  function saveFaviconUrl() {
    const serverId = document.getElementById('editServerId').value;
    const faviconUrl = document.getElementById('faviconUrlInput').value;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    // Send AJAX request to update the favicon URL
    fetch(`/servers/${serverId}.json`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        server: {
          favicon_url: faviconUrl
        }
      })
    })
    .then(data => {
        const urlElement = document.querySelector(`#favicon-url-${serverId}`);
        if (urlElement) {
          urlElement.textContent = faviconUrl;
        }
        const imgElement = document.querySelector(`#favicon-url-${serverId}`).closest('td').querySelector('img');
        if (imgElement) {
          imgElement.src = faviconUrl;
        }
        
        $('#editFaviconUrlModal').modal('hide');
    })
    .catch(error => {
      console.error('Error updating favicon URL:', error);
      alert('更新失败，请重试');
    })
  }
  
  // Function to initialize event listeners
  function initializeEventListeners() {
    // Remove existing event listeners to prevent duplicates
    const saveButton = document.getElementById('saveFaviconUrlBtn');
    const faviconUrlInput = document.getElementById('faviconUrlInput');
    
    // Add event listener to the save button
    saveButton.addEventListener('click', saveFaviconUrl);
    
    // Add event listener for Enter key in the input field
    faviconUrlInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        saveFaviconUrl();
      }
    });
  }
  
  // Initialize event listeners when the DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
  });
</script>

<script>
  function toggleIsNeedToFetchFromFofa(serverId, element) {
    fetch('/servers/' + serverId + '/toggle_is_need_to_fetch_from_fofa', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 更新图标显示
        if (data.is_need_to_fetch_from_fofa) {
          element.innerHTML = '<span style="color: green; font-size: 1.2em;">✓</span>';
        } else {
          element.innerHTML = '<span style="color: red; font-size: 1.2em;">✗</span>';
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showTemporaryMessage('更新失败，请重试', false);
    });
  }

  function toggleContent(element) {
    const parent = element.closest('td');
    const collapsedContent = parent.querySelector('.collapsed-content');
    const fullContent = parent.querySelector('.full-content');
    
    if (fullContent.style.display === 'none') {
      // 展开内容
      collapsedContent.style.display = 'none';
      fullContent.style.display = 'inline';
      element.innerHTML = '<span class="full-content">' + fullContent.innerHTML + '</span>';
    } else {
      // 折叠内容
      collapsedContent.style.display = 'inline';
      fullContent.style.display = 'none';
      element.innerHTML = '<span class="collapsed-content">Click to expand</span><span class="full-content" style="display: none;">' + fullContent.innerHTML + '</span>';
    }
  }

  function refreshFofaCount(serverId) {
    // 禁用按钮并显示加载状态
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '刷新中...';
    
    // 发起AJAX请求
    fetch(`/servers/${serverId}/update_fofa_count?type=favicon`, {
      method: 'GET',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 更新页面上的数值
        const countCell = button.closest('td');
        const countElement = countCell.querySelector('span') || countCell.firstChild;
        if (countElement) {
          countElement.textContent = data.subdomain_count || '0';
        }
        showTemporaryMessage('FOFA计数已更新', true);
      } else {
        showTemporaryMessage(data.message || '更新失败', false);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showTemporaryMessage('更新失败，请重试', false);
    })
    .finally(() => {
      // 恢复按钮状态
      button.disabled = false;
      button.textContent = originalText;
    });
  }
</script>

<table class='table table-bordered table-hovered table-striped'>
  <thead>
    <tr>
      <th colspan="10">
        Total: <%= @total_count %>
      </th>
    </tr>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th style="width: 50px;">Subdomain Count (Main Domain)<br/><small><%= @subdomain_main_count %> / <%= @total_count %></small></th>
      <th style="width: 50px;">Subdomain Count (Base Name)<br/><small><%= @subdomain_base_count %> / <%= @total_count %></small></th>
      <th style="width: 50px;">Subdomain Count (Favicon)<br/><small><%= @subdomain_favicon_count %> / <%= @total_count %></small></th>
      <th style="width: 50px;">Subdomain Total Count<br/><small><%= @subdomain_total_count %> / <%= @total_count %></small></th>
      <th style="width: 50px;">Is Need to Fetch from FOFA</th>
      <th style="width: 300px; word-wrap: break-word;">Favicon Hash <br/> <small><%= @favicon_hash_non_empty_count %> run / <%= @favicon_hash_without_err_count %> OK / <%= @total_count %> all</small></th>

      <th>Favicon Hash of FOFA</th>
      <th>Favicon URL</th>
      <th style="width: 50px;">Is Detected by Favihunter</th>
      <th style="width: 50px;">Is Detected by FOFA</th>

      <th style='width: 100px'>Title of FOFA</th>
      
      <th>Created At</th>
      <th>Updated At</th>
    </tr>
  </thead>

  <tbody>
    <% @servers.each do |server| %>
      <tr>
        <td><%= server.id %></td>
        <td><%= link_to server.name, server %>
                
        </td>
        <td style="width: 50px;<%= ' color: green;' if server.subdomain_count_main_domain_of_fofa_result.to_i > 1000 %><%= ' color: red;' if server.subdomain_count_main_domain_of_fofa_result.to_i > 3000 %>"><%= server.subdomain_count_main_domain_of_fofa_result %>
        <br/>
        <%= link_to "fofa", "https://fofa.info/result?qbase64=#{Base64.strict_encode64("domain=\"#{server.name}\"")}&page=1&page_size=50", target: "_blank" %>        
        </td>
        <td style="width: 50px;<%= ' color: green;' if server.subdomain_count_base_name_of_fofa_result.to_i > 1000 %><%= ' color: red;' if server.subdomain_count_base_name_of_fofa_result.to_i > 3000 %>"><%= server.subdomain_count_base_name_of_fofa_result %>
        <br/>
        <%= link_to "fofa", "https://fofa.info/result?qbase64=#{Base64.strict_encode64("domain*=\"*.#{server.name.split('.').first}.*\"")}&page=1&page_size=50", target: "_blank" %>
        </td>
        <td style="width: 50px;<%= ' color: green;' if server.subdomain_count_favicon_of_fofa_result.to_i > 1000 %><%= ' color: red;' if server.subdomain_count_favicon_of_fofa_result.to_i > 3000 %>"><%= server.subdomain_count_favicon_of_fofa_result %>
        <br/>
        <%= link_to "fofa", "https://fofa.info/result?qbase64=#{Base64.strict_encode64("icon_hash=\"#{server.favicon_hash_of_fofa_result}\"")}&page=1&page_size=50", target: "_blank" %>
        <button class="btn btn-sm btn-primary refresh-btn" data-server-id="<%= server.id %>" onclick="refreshFofaCount(<%= server.id %>)">刷新</button>
        </td>
        <td style="<%= ' color: green;' if server.subdomain_total_count_of_fofa_result.to_i > 1000 %><%= ' color: red;' if server.subdomain_total_count_of_fofa_result.to_i > 3000 %>"><%= server.subdomain_total_count_of_fofa_result %></td>
        <td style="width: 50px; text-align: center;">
          <a href="javascript:void(0)" onclick="toggleIsNeedToFetchFromFofa(<%= server.id %>, this)">
            <% if server.is_need_to_fetch_from_fofa %>
              <span style="color: green; font-size: 1.2em;">✓</span>
            <% else %>
              <span style="color: red; font-size: 1.2em;">✗</span>
            <% end %>
          </a>
        </td>        
        <td style="width: 300px; word-wrap: break-word; word-break: break-all; white-space: pre-wrap;">
          <a href="javascript:void(0);" onclick="toggleContent(this)">
            <span class="collapsed-content">Click to expand</span>
            <span class="full-content" style="display: none;"><%= server.favicon_hash_of_fofa_result %></span>
          </a>
        </td>
        <td><%= server.favicon_hash_of_fofa %></td>
        <td>
          <% if server.favicon_url.present? %>
            <img src="<%= server.favicon_url %>" alt="Favicon" style="max-width: 32px; max-height: 32px;"> <br/>
            <span id="favicon-url-<%= server.id %>"><%= server.favicon_url %></span> <br/>
            <a href="javascript:void(0)" onclick="openEditFaviconUrlModal(<%= server.id %>, '<%= server.favicon_url %>')" style="color: #007bff; text-decoration: none; margin-right: 10px;">
              <i class="fas fa-edit"></i> 编辑
            </a>
            <%= link_to raw('<i class="fas fa-external-link-alt" style="color: #28a745; font-size: 16px;"></i>'), server.favicon_url, target: '_blank', title: '访问', style: 'text-decoration: none;' %>
          <% else %>
            No favicon URL <br/>
            <a href="javascript:void(0)" onclick="openEditFaviconUrlModal(<%= server.id %>, '')" style="color: #007bff; text-decoration: none;">
              <i class="fas fa-edit"></i> 添加
            </a>
          <% end %>
        </td>
        <td style="width: 50px;<%= ' color: green;' if server.is_detected_by_favihunter %>"><%= server.is_detected_by_favihunter ? 'true' : 'false' %></td>
        <td style="width: 50px;<%= ' color: green;' if server.is_detected_by_fofa %>"><%= server.is_detected_by_fofa ? 'true' : 'false' %></td>

        <td style="width: 100px; word-wrap: break-word; word-break: break-all; white-space: pre-wrap;"><%= server.title_of_fofa %></td>
        <td><%= server.created_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
        <td><%= server.updated_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= paginate @servers %>